# Task-Tide Development: Full-Stack Development Environment
# Single container for development with hot-reload

FROM node:18-alpine

# Install Python for frontend development server
RUN apk add --no-cache python3 py3-pip curl

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY frontend/package*.json ./frontend/
COPY backend/package*.json ./backend/

# Install dependencies
RUN npm install && \
    cd frontend && npm install && \
    cd ../backend && npm install

# Copy source code
COPY . .

# Create startup script
RUN echo '#!/bin/sh' > /app/start-dev.sh && \
    echo 'echo "Starting Task-Tide development environment..."' >> /app/start-dev.sh && \
    echo 'echo "Backend: http://localhost:3001"' >> /app/start-dev.sh && \
    echo 'echo "Frontend: http://localhost:3000"' >> /app/start-dev.sh && \
    echo 'echo "API Health: http://localhost:3001/health"' >> /app/start-dev.sh && \
    echo 'echo ""' >> /app/start-dev.sh && \
    echo 'cd backend && npm run dev &' >> /app/start-dev.sh && \
    echo 'cd frontend && npm run dev &' >> /app/start-dev.sh && \
    echo 'wait' >> /app/start-dev.sh && \
    chmod +x /app/start-dev.sh

# Expose ports
EXPOSE 3000 3001

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3001/health || exit 1

# Start development environment
CMD ["/app/start-dev.sh"]
